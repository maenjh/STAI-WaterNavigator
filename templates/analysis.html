<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Points Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <style>
        .leaflet-container {
            background-color: #f0f9ff;
        }
        .blinking-animation{
            animation:blinking 1.5s ease-in-out infinite alternate
        }
        @keyframes blinking{
            0%{ opacity:1 }
            100%{ opacity:0.2 }
        }
        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2rem;
            background-color: #333;
            animation: blink 0.7s infinite;
        }
        .marker-cluster-small {
            background-color: rgba(191, 219, 254, 0.6) !important;
        }
        .marker-cluster-small div {
            background-color: rgba(147, 197, 253, 0.6) !important;
        }

        .marker-cluster-medium {
            background-color: rgba(96, 165, 250, 0.6) !important;
        }
        .marker-cluster-medium div {
            background-color: rgba(59, 130, 246, 0.6) !important;
        }

        .marker-cluster-large {
            background-color: rgba(37, 99, 235, 0.6) !important;
        }
        .marker-cluster-large div {
            background-color: rgba(29, 78, 216, 0.6) !important;
        }
    </style>
</head>
<body class="bg-[#f0f9ff]">
    <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#dbeafe] px-10 py-4 shadow-sm bg-white">
        <a href="/" class="flex items-center gap-3 text-[#1e3a8a]">
            <span class="material-icons text-3xl text-[#2563eb]">water_drop</span>
            <h2 class="text-[#1e3a8a] text-2xl font-bold leading-tight tracking-tight">Water Navigator</h2>
        </a>
        <div class="flex flex-1 justify-end gap-6">
            <nav class="flex items-center gap-6">
                <a class="text-[#334155] hover:text-[#2563eb] text-base font-medium leading-normal transition-colors" href="/#about">About</a>
                <a class="text-[#334155] hover:text-[#2563eb] text-base font-medium leading-normal transition-colors" href="/#features">Core Features</a>
                <a class="text-[#334155] hover:text-[#2563eb] text-base font-medium leading-normal transition-colors" href="/#use-cases">Use Cases</a>
                <a class="text-[#334155] hover:text-[#2563eb] text-base font-medium leading-normal transition-colors" href="/#contact">Contact</a>
            </nav>
            <button class="flex min-w-[100px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-11 px-6 bg-[#2563eb] text-[#f0f9ff] text-base font-bold leading-normal tracking-[0.015em] hover:bg-[#1d4ed8] transition-colors shadow-md hover:shadow-lg">
                <span class="truncate">Request a Demo</span>
            </button>
        </div>
    </header>
    <div class="min-h-screen flex flex-col p-4">
        <main class="w-full max-w-screen-2xl mx-auto flex flex-col lg:flex-row gap-8 flex-1">

            <!-- Left Panel (Map) -->
            <div class="flex-1 flex flex-col gap-4">
                <div id="map" class="flex-1 rounded-xl shadow-lg">
                    <!-- Map is rendered here -->
                </div>
            </div>

            <!-- Right Panel (Controls) -->
            <aside class="w-full lg:w-[420px] bg-white rounded-2xl shadow-xl p-6 flex flex-col gap-6 overflow-y-auto">

                <!-- Filters -->
                <div>
                    <h2 class="text-xl font-bold mb-4 text-[#1e3a8a]">Filters</h2>
                    <form>
                        <div class="mb-4">
                            <label for="country-select" class="block text-sm font-medium text-gray-700 mb-1">Country</label>
                            <select id="country-select" class="w-full border-gray-300 rounded-md shadow-sm">
                                <option>Ethiopia</option>
                                <option>Angola</option>
                                <option>Bangladesh</option>
                                <option>Cambodia</option>
                                <option>Haiti</option>
                                <option>Laos</option>
                                <option>Madagascar</option>
                                <option>Myanmar</option>
                                <option>Nepal</option>
                                <option>Senegal</option>
                                <option>Somalia</option>
                                <option>Tanzania</option>
                                <option>Uganda</option>
                                <option>Yemen</option>
                            </select>
                        </div>
                        <div>
                            <label for="region-select" class="block text-sm font-medium text-gray-700 mb-1">Region</label>
                            <select id="region-select" disabled class="w-full border-gray-300 rounded-md shadow-sm bg-gray-100">
                                <option>Loading regions...</option>
                            </select>
                        </div>
                    </form>
                </div>

                <!-- Core Analysis -->
                <div>
                    <h2 class="text-xl font-bold mb-2 text-[#1e3a8a]">Core Analysis</h2>
                    <div id="core-analysis-controls" class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm font-bold mb-2">Run Analysis</p>
                        <button id="start-analysis-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition w-full">
                            Start Analysis
                        </button>
                    </div>
                    <div id="analysis-processing-indicator" class="hidden mt-2">
                        <p class="text-gray-600 animate-pulse">processing...</p>
                    </div>
                </div>

                <!-- Analysis Results -->
                <div id="analysis-results-wrapper" class="hidden">
                    <h2 class="text-xl font-bold mb-2 text-[#1e3a8a]">Analysis Results</h2>
                    <div id="analysis-results">
                        <h3 class="text-lg font-semibold">Candidate Sites</h3>
                        <p class="text-gray-600">Found <span id="candidate-sites-count" class="font-bold">0</span> candidate sites.</p>
                        <div id="candidate-sites-list" class="mt-2 max-h-48 overflow-y-auto"></div>
                        
                        <!-- Generate Report Button -->
                        <div class="mt-4">
                            <button id="generate-report-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition w-full opacity-50 cursor-not-allowed" disabled>
                                Generate Report
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="mt-auto">
                    <h2 class="text-xl font-bold mb-2 text-[#1e3a8a]">Legend</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="material-icons text-blue-500">place</span>
                                <span>Existing Water Point</span>
                            </div>
                            <span id="existing-water-points-count" class="font-bold">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="material-icons text-red-500">place</span>
                                <span>Recommended Site</span>
                            </div>
                            <span id="candidate-sites-count-legend" class="font-bold">0</span>
                        </div>
                    </div>
                </div>

            </aside>
        </main>

        <!-- Report Section -->
        <section id="report-container" class="hidden w-full max-w-screen-2xl mx-auto mt-8 p-4">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Generated Report</h2>
                <div id="report-content" class="prose max-w-none text-gray-700"></div>
            </div>
        </section>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const map = L.map('map').setView([9.145, 40.4897], 6);
        
        map.whenReady(() => {
            setTimeout(() => map.invalidateSize(), 100);
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const countryCoordinates = {
            "Ethiopia": { lat: 9.145, lon: 40.4897, zoom: 6 },
            "Angola": { lat: -11.2027, lon: 17.8739, zoom: 5 },
            "Bangladesh": { lat: 23.6850, lon: 90.3563, zoom: 7 },
            "Cambodia": { lat: 12.5657, lon: 104.9910, zoom: 7 },
            "Haiti": { lat: 18.9712, lon: -72.2852, zoom: 8 },
            "Laos": { lat: 19.8563, lon: 102.4955, zoom: 6 },
            "Madagascar": { lat: -18.7669, lon: 46.8691, zoom: 5 },
            "Myanmar": { lat: 21.9162, lon: 95.9560, zoom: 5 },
            "Nepal": { lat: 28.3949, lon: 84.1240, zoom: 7 },
            "Senegal": { lat: 14.4974, lon: -14.4524, zoom: 7 },
            "Somalia": { lat: 5.1521, lon: 46.1996, zoom: 6 },
            "Tanzania": { lat: -6.3690, lon: 34.8888, zoom: 6 },
            "Uganda": { lat: 1.3733, lon: 32.2903, zoom: 7 },
            "Yemen": { lat: 15.5527, lon: 48.5164, zoom: 6 }
        };

        let ethiopiaRegions = {
            "Addis Abeba": { lat: 9.0, lon: 38.75 },
            "Afar": { lat: 11.71, lon: 41.03 },
            "Amhara": { lat: 11.59, lon: 37.95 },
            "Benishangul-Gumuz": { lat: 10.77, lon: 35.61 },
            "Dire Dawa": { lat: 9.6, lon: 41.85 },
            "Gambela": { lat: 7.91, lon: 34.66 },
            "Harari": { lat: 9.31, lon: 42.12 },
            "Oromia": { lat: 7.55, lon: 40.63 },
            "SNNP": { lat: 6.35, lon: 36.67 },
            "Somali": { lat: 7.22, lon: 43.79 },
            "Tigray": { lat: 13.88, lon: 39.13 }
        };
        
        let regionGeojsonData = null;
        let regionBoundaryLayer = null;
        let specialHighlightLayer = L.layerGroup();
        let allWaterPointsData = [];
        let waterPointsLayerGroup = L.markerClusterGroup();
        let candidateSiteLayerGroup = L.layerGroup();

        const waterPointIcon = L.divIcon({
            html: `<span class="material-icons text-blue-500" style="font-size: 24px;">place</span>`,
            className: 'custom-div-icon',
            iconSize: [24, 24],
            iconAnchor: [12, 24]
        });

        function createNumberedIcon(number) {
            return L.divIcon({
                html: `
                    <div class="relative flex items-center justify-center">
                        <span class="material-icons text-red-500" style="font-size: 36px;">place</span>
                        <span class="absolute text-white text-xs font-bold" style="top: 8px;">${number}</span>
                    </div>
                `,
                className: 'custom-numbered-icon',
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            });
        }
        
        function highlightSpecialRegions() {
            if (specialHighlightLayer) {
                specialHighlightLayer.clearLayers();
            }

            if (regionGeojsonData) {
                const regionName = "Bani Shangul-Gumuz";
                const regionFeature = regionGeojsonData.features.find(
                    feature => feature.properties.NAME_1 === regionName
                );

                if (regionFeature) {
                    const highlight = L.geoJSON(regionFeature, {
                        style: {
                            color: "#800080",
                            weight: 1,
                            opacity: 0.6,
                            fillColor: "#800080",
                            fillOpacity: 0.2
                        }
                    }).bindPopup("Benishangul-Gumuz");
                    specialHighlightLayer.addLayer(highlight);
                }
            }
            
            const lakeTanaCoords = [12.02, 37.31];
            const lakeTanaRadius = 35000;
            const lakeTanaCircle = L.circle(lakeTanaCoords, {
                radius: lakeTanaRadius,
                color: "#800080",
                weight: 1,
                opacity: 0.6,
                fillColor: "#800080",
                fillOpacity: 0.2
            }).bindPopup("Lake Tana");
            specialHighlightLayer.addLayer(lakeTanaCircle);
        }

        function loadData() {
            Promise.all([
                fetch('/api/waterpoints').then(res => res.json()),
                fetch('/static/ethiopia_regions.json').then(res => res.json())
            ]).then(([waterPoints, regions]) => {
                
                regionGeojsonData = regions;
                highlightSpecialRegions();
                
                const regionFeatures = regions.features;
                const pointsInEthiopia = waterPoints.filter(point => {
                    if (!point.lat || !point.lon) return false;
                    const turfPoint = turf.point([point.lon, point.lat]);
                    for (const feature of regionFeatures) {
                        if (turf.booleanPointInPolygon(turfPoint, feature)) {
                            return true;
                        }
                    }
                    return false;
                });
                
                allWaterPointsData = pointsInEthiopia; 

                document.getElementById('existing-water-points-count').textContent = pointsInEthiopia.length.toLocaleString();
                waterPointsLayerGroup.clearLayers();
                const markers = pointsInEthiopia.map(point => {
                    return L.marker([point.lat, point.lon], {
                        icon: waterPointIcon
                    }).bindPopup(`Water Point: ${parseFloat(point.lat).toFixed(4)}, ${parseFloat(point.lon).toFixed(4)}`);
                });
                waterPointsLayerGroup.addLayers(markers);

            }).catch(error => {
                console.error('Error loading map data:', error);
            });
        }
        
        loadData();

        map.addLayer(waterPointsLayerGroup);
        map.addLayer(candidateSiteLayerGroup);
        map.addLayer(specialHighlightLayer);
       
        const regionSelect = document.getElementById('region-select');
        
        fetch('/static/ethiopia_regions.json')
            .then(response => response.json())
            .then(data => {
                const regionNames = data.features.map(feature => feature.properties.NAME_1).sort();
                regionSelect.innerHTML = '<option value="">View All</option>';
                regionNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    regionSelect.appendChild(option);
                });
                regionSelect.disabled = false;
            })
            .catch(error => {
                console.error('Error loading region data:', error);
                regionSelect.disabled = true;
            });

        const countrySelect = document.getElementById('country-select');
        countrySelect.addEventListener('change', (event) => {
            const countryName = event.target.value;
            if (countryCoordinates[countryName]) {
                const { lat, lon, zoom } = countryCoordinates[countryName];
                map.flyTo([lat, lon], zoom);

                // For now, region and analysis are specific to Ethiopia
                const isEthiopia = countryName === 'Ethiopia';
                document.getElementById('region-select').disabled = !isEthiopia;
                document.getElementById('core-analysis-controls').style.display = isEthiopia ? 'block' : 'none';
                
                // Clear Ethiopia-specific layers if another country is selected
                if (!isEthiopia) {
                    waterPointsLayerGroup.clearLayers();
                    candidateSiteLayerGroup.clearLayers();
                    document.getElementById('analysis-results-wrapper').style.display = 'none';
                    if (regionBoundaryLayer) {
                        map.removeLayer(regionBoundaryLayer);
                    }
                } else {
                    // Reload Ethiopia data if selected back
                    loadData();
                }
            }
        });

        regionSelect.addEventListener('change', (event) => {
            const regionName = event.target.value;
            
            if (regionBoundaryLayer) {
                map.removeLayer(regionBoundaryLayer);
            }

            if (!regionName || regionName === "") {
                map.setView([9.145, 40.4897], 6);
                return;
            }

            if (regionGeojsonData) {
                const regionFeature = regionGeojsonData.features.find(
                    feature => feature.properties.NAME_1 === regionName
                );

                if (regionFeature) {
                    regionBoundaryLayer = L.geoJSON(regionFeature, {
                        style: {
                            color: "#3b82f6",
                            weight: 2,
                            opacity: 1,
                            fillColor: "#bfdbfe",
                            fillOpacity: 0.4
                        }
                    }).addTo(map);
                    map.fitBounds(regionBoundaryLayer.getBounds());
                } else {
                    if (ethiopiaRegions[regionName]) {
                        const { lat, lon } = ethiopiaRegions[regionName];
                        map.setView([lat, lon], 9);
                    }
                }
            }
        });

        const startAnalysisBtn = document.getElementById('start-analysis-btn');
        startAnalysisBtn.addEventListener('click', () => {
            startAnalysisBtn.parentElement.style.display = 'none';
            document.getElementById('analysis-processing-indicator').style.display = 'block';

            setTimeout(() => {
                document.getElementById('analysis-processing-indicator').style.display = 'none';
                document.getElementById('analysis-results-wrapper').style.display = 'block';
                
                const candidatePoints = findCandidateSites();
                displayCandidateSites(candidatePoints);
                
            }, 1500);
        });

        function findCandidateSites() {
            // Returns hardcoded candidate sites
            return [
                { lat: 5.905696, lon: 38.650472 },
                { lat: 10.819452, lon: 36.647936 },
                { lat: 8.204129, lon: 39.125290 },
                { lat: 7.49, lon: 38.53 }
            ];
        }

        function displayCandidateSites(sites) {
            candidateSiteLayerGroup.clearLayers();
            
            const listElement = document.getElementById('candidate-sites-list');
            const countElement = document.getElementById('candidate-sites-count');
            const legendCountElement = document.getElementById('candidate-sites-count-legend');
            
            listElement.innerHTML = '';
            
            if (!sites || sites.length === 0) {
                countElement.textContent = '0';
                legendCountElement.textContent = '0';
                listElement.innerHTML = '<p class="text-gray-500 text-sm">No candidate sites found.</p>';
                return;
            }

            const markers = [];

            sites.forEach((site, index) => {
                const siteNumber = index + 1;
                const lat = parseFloat(site.lat);
                const lon = parseFloat(site.lon);

                const marker = L.marker([lat, lon], {
                    icon: createNumberedIcon(siteNumber)
                }).bindPopup(`<b>Candidate Site #${siteNumber}</b><br>Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`);

                markers.push(marker);

                const listItem = document.createElement('div');
                listItem.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-blue-50 transition-colors';
                listItem.innerHTML = `
                    <div class="flex items-center gap-3 flex-grow cursor-pointer">
                        <span class="flex-shrink-0 flex items-center justify-center w-6 h-6 bg-red-500 text-white font-bold rounded-full text-sm">${siteNumber}</span>
                        <div class="text-sm">
                            <span class="font-medium text-gray-800">Lat: ${lat.toFixed(2)}</span>, 
                            <span class="font-medium text-gray-800">Lon: ${lon.toFixed(2)}</span>
                        </div>
                    </div>
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer" data-site-number="${siteNumber}" data-lat="${lat}" data-lon="${lon}">
                `;
                
                listItem.addEventListener('click', (e) => {
                    // Prevent map pan when clicking the checkbox
                    if (e.target.type !== 'checkbox') {
                        map.flyTo([lat, lon], 12);
                        marker.openPopup();
                    }
                });

                listElement.appendChild(listItem);
            });

            markers.forEach(marker => {
                candidateSiteLayerGroup.addLayer(marker);
            });
            
            countElement.textContent = sites.length;
            legendCountElement.textContent = sites.length;
        }

        // --- Report Generation Logic ---
        const reportBtn = document.getElementById('generate-report-btn');
        const resultsList = document.getElementById('candidate-sites-list');
        const reportContainer = document.getElementById('report-container');
        const reportContentEl = document.getElementById('report-content');

        function updateReportButtonState() {
            const checkedCheckboxes = resultsList.querySelectorAll('input[type="checkbox"]:checked');
            if (checkedCheckboxes.length > 0) {
                reportBtn.disabled = false;
                reportBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                reportBtn.disabled = true;
                reportBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        resultsList.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                updateReportButtonState();
            }
        });

        reportBtn.addEventListener('click', () => {
            const selectedSites = [];
            const checkedCheckboxes = resultsList.querySelectorAll('input[type="checkbox"]:checked');
            
            checkedCheckboxes.forEach(checkbox => {
                selectedSites.push({
                    site: checkbox.dataset.siteNumber,
                    lat: checkbox.dataset.lat,
                    lon: checkbox.dataset.lon
                });
            });

            if (selectedSites.length > 0) {
                generateReport();
            } else {
                alert('Please select at least one site to generate a report.');
            }
        });

        function generateReport() {
            reportContainer.classList.remove('hidden');
            
            const fullReportText = `
                <h3 class="text-xl font-bold mb-4">Comprehensive Analysis Report for 4 Well Candidates</h3>
                <p class="text-sm text-gray-500 mb-6">(Hambela Wamena, Ankasha, Dodota, Shala)</p>

                <h4 class="font-bold mt-6 mb-2">1. Evaluation Framework Summary</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Step</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Description</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Weight</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 text-sm">
                            <tr>
                                <td class="px-4 py-4">① Eligibility Filter</td>
                                <td class="px-4 py-4">
                                    <ul class="list-disc list-inside">
                                        <li>Outside 10 km radius of existing wells</li>
                                        <li>Groundwater potential ≥ I-M/H (or ‘Very High’)</li>
                                        <li>Land Use: Cropland/Settlement value = 0</li>
                                        <li>Drought Index ≤ 1.0 (Extreme) or ≥ 9.0 (Low Urgency)</li>
                                    </ul>
                                </td>
                                <td class="px-4 py-4">―</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-4">② Quantitative Score</td>
                                <td class="px-4 py-4">Population 30% · Groundwater 30% · Drought 20% · Land Use 20% (0–1 scale)</td>
                                <td class="px-4 py-4">100%</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-4">③ Quality Assurance</td>
                                <td class="px-4 py-4">Technical/financial feasibility (drilling success, water quality, solar panel area, accessibility)</td>
                                <td class="px-4 py-4">Supplementary</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-4">④ Conflict Risk</td>
                                <td class="px-4 py-4">Transnational water conflict, local/ethnic disputes, environmental regulations</td>
                                <td class="px-4 py-4">Narrative</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h4 class="font-bold mt-6 mb-2">2. Detailed Candidate Site Analysis</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">#</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Coordinates / Admin Area</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Key Selection Rationale</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Potential Conflict/Environmental Risk</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 text-sm">
                            <tr>
                                <td class="px-4 py-4">1</td>
                                <td class="px-4 py-4">5.91 °N, 38.65 °E<br>Hambela Wamena (Guji Zone)</td>
                                <td class="px-4 py-4">
                                    <ul class="list-disc list-inside">
                                        <li>Population: 296 persons/km²</li>
                                        <li>54.5 km from existing well</li>
                                        <li>Genale-Dawa basalt aquifer, I-M/H rating → 1–5 L s⁻¹ yield expected <br><small>scirp.org, etd.aau.edu.et</small></li>
                                        <li>Persistent drought/fodder shortage area</li>
                                    </ul>
                                </td>
                                <td class="px-4 py-4"><strong>Medium</strong> – Genale-Dawa basin extends to Kenya/Somalia, requiring future negotiations for irrigation expansion. Past disputes over well ownership among pastoralists. <br><small>earthisland.org</small></td>
                            </tr>
                            <tr>
                                <td class="px-4 py-4">2</td>
                                <td class="px-4 py-4">10.82 °N, 36.65 °E<br>Ankasha (Awi Zone)</td>
                                <td class="px-4 py-4">
                                    <ul class="list-disc list-inside">
                                        <li>Population: 230 persons/km²</li>
                                        <li>Upper Blue Nile, I-M/H geology <br><small>sciencedirect.com</small></li>
                                        <li>Drought Index 0.0 → Highest priority need</li>
                                    </ul>
                                </td>
                                <td class="px-4 py-4"><strong>High</strong> – New abstraction in Blue Nile basin maintains tension with Egypt/Sudan. Diplomatically sensitive area linked to GERD operation/filling schedule. <br><small>apnews.com, carnegieendowment.org, sciencedirect.com</small></td>
                            </tr>
                            <tr>
                                <td class="px-4 py-4">3</td>
                                <td class="px-4 py-4">8.20 °N, 39.13 °E<br>Dodota (Arsi Zone)</td>
                                <td class="px-4 py-4">
                                    <ul class="list-disc list-inside">
                                        <li>Population: 212 persons/km²</li>
                                        <li>22.6 km from existing well</li>
                                        <li>Rift Valley basalt, I-M/H</li>
                                        <li>Potential for dual drinking/livestock use</li>
                                    </ul>
                                </td>
                                <td class="px-4 py-4"><strong>Low (Diplomatic)</strong> – Closed inland basin.<br><strong>Caution (Health)</strong> – High fluoride/salinity potential, requires budgeting for filters. <br><small>researchgate.net, pmc.ncbi.nlm.nih.gov</small></td>
                            </tr>
                            <tr>
                                <td class="px-4 py-4">4</td>
                                <td class="px-4 py-4">7.49 °N, 38.53 °E<br>Shala (West Arsi Zone)</td>
                                <td class="px-4 py-4">
                                    <ul class="list-disc list-inside">
                                        <li>Population: 283 persons/km²</li>
                                        <li>Very High groundwater rating, >18 km from wells</li>
                                        <li>Recurrent drought & IPC Phase 2-3 <br><small>sciencedirect.com, amazon.com</small></li>
                                    </ul>
                                </td>
                                <td class="px-4 py-4"><strong>Very Low (Diplomatic)</strong> – Closed lake basin.<br><strong>Medium (Local)</strong> – Overlaps with pastoralist migration routes, requires usage rules & management committee. <br><small>ejol.aau.edu.et</small></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h4 class="font-bold mt-6 mb-2">3. Why These Four Locations?</h4>
                <h5 class="font-semibold mt-4 mb-1">Maximize Socio-Economic Benefit</h5>
                <p>Average population of 255 persons/km², located 18–55 km from existing well networks, avoiding "redundant investment" risk.</p>
                <h5 class="font-semibold mt-4 mb-1">High Probability of Groundwater Success</h5>
                <p>All four sites are on fractured basalt aquifers (I-M/H) or rated "Very High," predicting ≥80% drilling success rate.</p>
                <h5 class="font-semibold mt-4 mb-1">Urgent Drought and Water Needs</h5>
                <p>Hambela, Ankasha, Dodota, and Shala are all in water-stressed areas with a Drought Index of 0.0 or IPC Phase 2-3.</p>
                <h5 class="font-semibold mt-4 mb-1">Minimize Land Conflict</h5>
                <p>Geo-Wiki value of 0 indicates communal pastureland/grassland or park buffer zones, not private cropland/settlements, reducing compensation burdens.</p>

                <h4 class="font-bold mt-6 mb-2">4. Integrated Conflict & Threat Assessment</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Type</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Location</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Risk Summary</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Recommended Response</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 text-sm">
                            <tr>
                                <td class="px-4 py-4">Transnational Water Conflict</td>
                                <td class="px-4 py-4">Ankasha (Blue Nile)</td>
                                <td class="px-4 py-4">Monitored by Egypt/Sudan for "new upstream development" post-GERD.</td>
                                <td class="px-4 py-4">Publish real-time water level/abstraction data to international platforms (NBI, AU-WRG).</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-4">Linked Basin Negotiations</td>
                                <td class="px-4 py-4">Hambela Wamena</td>
                                <td class="px-4 py-4">Future water allocation negotiations needed for downstream irrigation in Somalia/Kenya.</td>
                                <td class="px-4 py-4">Register project with IGAD water working group, pursue trilateral MOU.</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-4">Local Pastoral/Ethnic Conflict</td>
                                <td class="px-4 py-4">Hambela & Shala</td>
                                <td class="px-4 py-4">Armed clashes documented over borehole ownership and access control.</td>
                                <td class="px-4 py-4">Establish well management committee, including traditional (Gadaa) decision-making processes.</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-4">Water Quality & Health Risk</td>
                                <td class="px-4 py-4">Dodota</td>
                                <td class="px-4 py-4">High fluoride/salinity → risk of dental/skeletal fluorosis.</td>
                                <td class="px-4 py-4">Include budget for RO/Activated Alumina filters (CapEx + OpEx ≈ 0.5 US¢ L⁻¹).</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h4 class="font-bold mt-6 mb-2">5. Overall Recommendations</h4>
                <h5 class="font-semibold mt-4 mb-1">Implementation Priority</h5>
                <p>Ankasha ↔ Hambela Wamena (equal urgency/benefit) → conduct parallel feasibility studies. Dodota & Shala as second phase.</p>
                <h5 class="font-semibold mt-4 mb-1">Diplomacy & Data Transparency</h5>
                <p>Ankasha project to stream real-time abstraction/level data to the Nile Basin Initiative portal.</p>
                <h5 class="font-semibold mt-4 mb-1">Local Participation</h5>
                <p>Mandate community well management committees + traditional elder consultation for the two pastoralist sites (Hambela, Shala).</p>
                <h5 class="font-semibold mt-4 mb-1">Water Quality Management</h5>
                <p>Budget for fluoride removal filters at Dodota, with annual water quality monitoring.</p>
                <h5 class="font-semibold mt-4 mb-1">Long-Term Monitoring</h5>
                <p>Install IoT flow/level sensors + satellite uplink at all 4 sites for public dashboard transparency.</p>

                <p class="mt-6">These four sites are designed to achieve maximum social benefit while minimizing diplomatic and local conflict. Proceeding with phased feasibility studies (EIA, water quality, test drilling) before construction is recommended.</p>
            `;

            const progressSteps = [
                { percent: 0, text: "Initializing analysis..." },
                { percent: 25, text: "Gathering geological data..." },
                { percent: 50, text: "Analyzing population density..." },
                { percent: 75, text: "Assessing conflict & environmental risk..." },
                { percent: 100, text: "Compiling final report..." }
            ];

            reportContentEl.innerHTML = `
                <div id="report-progress-container" class="py-8">
                    <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                        <div id="report-progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500 ease-in-out" style="width: 0%"></div>
                    </div>
                    <p id="report-progress-text" class="text-center text-gray-600 font-semibold"></p>
                </div>
            `;

            const progressBar = document.getElementById('report-progress-bar');
            const progressText = document.getElementById('report-progress-text');
            let currentStep = 0;

            function updateProgress() {
                if (currentStep < progressSteps.length) {
                    const step = progressSteps[currentStep];
                    progressBar.style.width = step.percent + '%';
                    progressText.textContent = step.text;
                    currentStep++;
                    setTimeout(updateProgress, 1200);
                } else {
                    reportContentEl.innerHTML = fullReportText;
                    scrollToReport();
                }
            }
            updateProgress();
        }

        function scrollToReport() {
            reportContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
</script>
</body>
</html> 